name: Manual Branch Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦æž„å»ºçš„åˆ†æ”¯åç§°'
        required: true
        default: 'main'
        type: string
      tag_suffix:
        description: 'è‡ªå®šä¹‰æ ‡ç­¾åŽç¼€ (å¯é€‰)'
        required: false
        type: string
      push_to_registry:
        description: 'æ˜¯å¦æŽ¨é€åˆ°é•œåƒä»“åº“'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: xuchang200/web

jobs:
  manual-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout specified branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      if: ${{ github.event.inputs.push_to_registry == 'true' }}
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate custom tags
      id: tags
      run: |
        BRANCH_NAME=${{ github.event.inputs.branch }}
        SAFE_BRANCH_NAME=$(echo "${BRANCH_NAME}" | sed 's/[^a-zA-Z0-9._-]/-/g')
        
        # åŸºç¡€æ ‡ç­¾
        TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SAFE_BRANCH_NAME}"
        
        # æ·»åŠ æ—¶é—´æˆ³æ ‡ç­¾
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SAFE_BRANCH_NAME}-${TIMESTAMP}"
        
        # æ·»åŠ  SHA æ ‡ç­¾
        SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
        TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SAFE_BRANCH_NAME}-${SHA_SHORT}"
        
        # å¦‚æžœæœ‰è‡ªå®šä¹‰åŽç¼€
        if [ ! -z "${{ github.event.inputs.tag_suffix }}" ]; then
          TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SAFE_BRANCH_NAME}-${{ github.event.inputs.tag_suffix }}"
        fi
        
        # å¦‚æžœæ˜¯ä¸»åˆ†æ”¯ï¼Œæ·»åŠ  latest æ ‡ç­¾
        if [ "${BRANCH_NAME}" = "main" ] || [ "${BRANCH_NAME}" = "master" ]; then
          TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        fi
        
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "safe_branch_name=${SAFE_BRANCH_NAME}" >> $GITHUB_OUTPUT

    - name: Create .env file for build
      run: |
        cat << 'EOF' > .env
        # Frontend Environment Variables
        VITE_API_URL=/api
        VITE_APP_NAME=Personal Game Website
        VITE_APP_VERSION=${{ github.event.inputs.branch }}-${{ github.run_number }}
        
        # Backend Environment Variables (build-time only)
        DATABASE_URL=postgresql://user:password@localhost:5432/gamedb
        JWT_SECRET=build-time-secret
        REDIS_URL=redis://localhost:6379
        NODE_ENV=production
        
        # Upload Configuration
        UPLOAD_MAX_SIZE=10485760
        UPLOAD_ALLOWED_TYPES=jpg,jpeg,png,gif,zip
        EOF

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event.inputs.push_to_registry == 'true' }}
        tags: ${{ steps.tags.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          org.opencontainers.image.title=Personal Game Website
          org.opencontainers.image.description=Manual build from branch ${{ github.event.inputs.branch }}

    - name: Create build summary
      run: |
        echo "## ðŸ”¨ æ‰‹åŠ¨æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: \`${{ github.event.inputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **æŽ¨é€åˆ°ä»“åº“**: ${{ github.event.inputs.push_to_registry }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.push_to_registry }}" = "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ç”Ÿæˆçš„é•œåƒæ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tags.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ ä½¿ç”¨æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æ‹‰å–é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.safe_branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# è¿è¡Œå®¹å™¨" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 3000:3000 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.safe_branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi